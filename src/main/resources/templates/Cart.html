<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Your Cart | Pure Healthy Eats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <!-- Chosen Palette: Fresh Greens, Clean Neutrals -->
    <!-- Application Structure Plan: The page is structured to provide a clear, linear path for the user from reviewing their items to completing their purchase. The main content area is a responsive list of cart items, followed by a dedicated, highlighted summary area. This layout guides the user's eye to the most critical information (total price) and the primary call to action (Checkout), which is designed to be visually prominent to encourage conversion. Data persistence is handled via a new AJAX call to a server endpoint. -->
    <!-- Visualization & Content Choices:
        - Report Info: Cart Items (List). Goal: Review & Manage. Viz/Presentation Method: Interactive cards with item name, price, quantity, and subtotal. Interaction: Buttons for increasing/decreasing quantity and removing items. Justification: This card-based layout is modern, responsive, and better for displaying item details than a traditional table, especially on mobile. The interactive buttons provide a clear and intuitive way to manage the cart. Library/Method: HTML/CSS with jQuery for AJAX.
        - Report Info: Total Amount. Goal: Inform & Encourage Purchase. Viz/Presentation Method: Prominent, large text in a summary block. Interaction: Checkout button. Justification: A visually distinct summary section draws attention to the final cost, which is a key psychological trigger for conversion. The button's size and color make it the primary call to action. Library/Method: HTML/CSS with JS for the checkout logic.
        - Report Info: Order Details. Goal: Store & Record. Viz/Presentation Method: Server-side database (MySQL). Interaction: Checkout button click triggers an AJAX call to a server endpoint. Justification: This approach correctly delegates database operations to the backend, which is the standard and secure way to handle transactions with a relational database like MySQL. Library/Method: jQuery for the AJAX request.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f5f5f4;
            font-family: 'Poppins', sans-serif;
        }
        .container {
            max-width: 1000px;
        }
        .cart-header {
            background-color: #ffffff;
            border-bottom: 2px solid #e7e5e4;
            padding: 1.5rem;
            border-radius: 1rem 1rem 0 0;
        }
        .cart-item-card {
            background-color: #ffffff;
            border-bottom: 1px solid #e7e5e4;
            padding: 1.5rem;
            transition: box-shadow 0.2s ease-in-out;
        }
        .cart-item-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .quantity-controls .btn {
            background-color: #f5f5f4;
            border: 1px solid #e7e5e4;
            transition: all 0.2s ease-in-out;
        }
        .quantity-controls .btn:hover {
            background-color: #e7e5e4;
        }
        .quantity-controls .qty {
            border: 1px solid #e7e5e4;
            background-color: #ffffff;
        }
        .remove-item-btn {
            color: #dc3545;
            background-color: transparent;
            border: none;
            transition: color 0.2s;
        }
        .remove-item-btn:hover {
            color: #bd2130;
        }
        .order-summary {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0 0 1rem 1rem;
            border-top: 2px solid #e7e5e4;
        }
        .total-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: #16a34a;
        }
        .checkout-btn {
            background-color: #16a34a;
            color: white;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .checkout-btn:hover {
            background-color: #15803d;
        }
        .empty-cart-container {
            background-color: #ffffff;
            padding: 4rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5">
    <h1 class="text-center font-extrabold text-green-700 mb-6 text-4xl md:text-5xl">Your Cart</h1>

    <div class="cart-content">
        <div th:if="${#lists.isEmpty(cartItems)}" class="empty-cart-container text-center">
            <i class="fas fa-shopping-basket text-gray-400 mb-4" style="font-size: 5rem;"></i>
            <h3 class="text-2xl font-semibold mb-2">Your cart is empty!</h3>
            <p class="text-gray-600 mb-4">Looks like you haven't added anything yet. Explore our delicious menu.</p>
            <a href="/menu" class="btn btn-lg btn-success">Start Shopping</a>
        </div>

        <div th:if="${!#lists.isEmpty(cartItems)}">
            <div class="cart-items-list mb-4">
                <!-- ALIGNMENT FIX: Using a more rigid flex structure for the header -->
                <div class="d-none d-md-flex align-items-center text-muted px-4 py-3 bg-white rounded-t-lg">
                    <div class="flex-grow-1">Item</div>
                    <div class="text-end" style="width: 15%;">Price</div>
                    <div class="text-center" style="width: 25%;">Quantity</div>
                    <div class="text-end" style="width: 15%;">Subtotal</div>
                    <div class="text-end" style="width: 10%;"></div>
                </div>

                <div th:each="item : ${cartItems}" th:attr="data-id=${item.id}" class="cart-item-card d-flex flex-column flex-md-row align-items-md-center">
                    <!-- ALIGNMENT FIX: Applying consistent structure to item rows -->
                    <div class="flex-grow-1 mb-3 mb-md-0">
                        <span class="font-bold" th:text="${item.name}"></span>
                    </div>

                    <!-- Mobile-only Price -->
                    <div class="d-md-none text-muted mb-2 w-100">Price: <span class="fw-semibold" th:text="'₹' + ${#numbers.formatDecimal(item.price, 1, 2)}"></span></div>

                    <!-- Desktop Price -->
                    <div class="d-none d-md-block text-end" style="width: 15%;">
                        <span class="font-semibold price" th:text="${#numbers.formatDecimal(item.price, 1, 2)}"></span>
                    </div>

                    <!-- Quantity Controls - ERROR FIX: Removed duplicate width attribute -->
                    <div class="d-flex justify-content-center mb-3 mb-md-0" style="width: 25%;">
                        <div class="quantity-controls d-flex" style="max-width: 150px;">
                            <button class="btn btn-sm decrease"><i class="fas fa-minus"></i></button>
                            <input type="text" th:value="${item.quantity}" class="form-control text-center qty" readonly style="border-radius: 0;">
                            <button class="btn btn-sm increase"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>

                    <!-- Mobile-only Subtotal -->
                    <div class="d-md-none text-muted mt-2 w-100">Subtotal: <span class="fw-semibold subtotal" th:text="'₹' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}"></span></div>

                    <!-- Desktop Subtotal -->
                    <div class="d-none d-md-block text-end" style="width: 15%;">
                        <span class="fw-semibold subtotal" th:text="${#numbers.formatDecimal(item.subtotal, 1, 2)}"></span>
                    </div>

                    <!-- Remove Button - ERROR FIX: Removed duplicate width attribute -->
                    <div class="text-end" style="width: 10%;">
                        <button class="btn remove-item-btn"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>

            <div class="order-summary d-flex flex-column flex-md-row justify-content-between align-items-center">
                <a href="/menu" class="btn btn-secondary mb-3 mb-md-0">Continue Shopping</a>
                <div class="text-center text-md-end">
                    <h4 class="text-xl font-bold text-gray-700">Total: ₹ <span class="total-price" id="total-amount" th:text="${#numbers.formatDecimal(totalAmount, 1, 2)}"></span></h4>
                    <a href="https://razorpay.me/@foodorder5088" target="_blank" class="btn btn-lg checkout-btn mt-3 w-full md:w-auto">
                        <i class="fas fa-credit-card me-2"></i>Pay Now
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(function () {
        const token = $("meta[name='_csrf']").attr("content");
        const header = $("meta[name='_csrf_header']").attr("content");
        $(document).ajaxSend(function(e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });
    });

    $(document).ready(function() {
        function updateTotalAmount() {
            let total = 0;
            $('.cart-item-card .subtotal').each(function() {
                const subtotalValue = parseFloat($(this).text().replace(/[^0-9.-]+/g, ""));
                if (!isNaN(subtotalValue)) {
                    total += subtotalValue;
                }
            });
            $('#total-amount').text(total.toFixed(2));
        }

        $(document).on('click', '.increase', function() {
            const row = $(this).closest('.cart-item-card');
            const id = row.data('id');
            const qtyInput = row.find('.qty');
            let qty = parseInt(qtyInput.val()) + 1;
            qtyInput.val(qty);
            const priceText = row.find('.price').text();
            const price = parseFloat(priceText.replace(/[^0-9.-]+/g, ""));
            if (!isNaN(price)) {
                row.find('.subtotal').text((price * qty).toFixed(2));
            }
            updateTotalAmount();
            $.post(`/cart/update/${id}?quantity=${qty}`)
                .done(function(response) {
                    $('#cart-size').text(response.cartSize);
                })
                .fail(function() {
                    alert('Failed to sync with server. Please refresh.');
                    qtyInput.val(qty - 1);
                    updateTotalAmount();
                });
        });

        $(document).on('click', '.decrease', function() {
            const row = $(this).closest('.cart-item-card');
            const id = row.data('id');
            const qtyInput = row.find('.qty');
            let qty = parseInt(qtyInput.val()) - 1;
            if (qty > 0) {
                qtyInput.val(qty);
                const priceText = row.find('.price').text();
                const price = parseFloat(priceText.replace(/[^0-9.-]+/g, ""));
                if (!isNaN(price)) {
                    row.find('.subtotal').text((price * qty).toFixed(2));
                }
                updateTotalAmount();
                $.post(`/cart/update/${id}?quantity=${qty}`)
                    .done(function(response) {
                        $('#cart-size').text(response.cartSize);
                    })
                    .fail(function() {
                        alert('Failed to sync with server. Please refresh.');
                        qtyInput.val(qty + 1);
                        updateTotalAmount();
                    });
            } else {
                removeItem(row, id);
            }
        });

        $(document).on('click', '.remove-item-btn', function() {
            const row = $(this).closest('.cart-item-card');
            const id = row.data('id');
            removeItem(row, id);
        });

        function removeItem(row, id) {
            row.remove();
            updateTotalAmount();
            $.get(`/cart/remove/${id}`)
                .done(function(response) {
                    $('#cart-size').text(response.cartSize);
                    if ($('.cart-item-card').length === 0) {
                        $('.cart-content').html(`
                            <div class="empty-cart-container text-center">
                                <i class="fas fa-shopping-basket text-gray-400 mb-4" style="font-size: 5rem;"></i>
                                <h3 class="text-2xl font-semibold mb-2">Your cart is empty!</h3>
                                <p class="text-gray-600 mb-4">Looks like you haven't added anything yet. Explore our delicious menu.</p>
                                <a href="/menu" class="btn btn-lg btn-success">Start Shopping</a>
                            </div>
                        `);
                    }
                })
                .fail(function() {
                    alert('Failed to remove item from server. Please refresh.');
                });
        }
    });
</script>
</body>
</html>
